---
import Layout from '../layouts/Layout.astro';
import words from '../data/words.json';

const existingWordNames = words.map((w) => w.word);
const lastDate = [...words].sort((a, b) => a.date.localeCompare(b.date)).at(-1)?.date ?? '';
---

<Layout title="Nieuwe woorden â€” Woordenschat">
  <h1 class="page-heading">Nieuwe woorden genereren</h1>

  <div class="gen-form" id="gen-form">
    <label class="gen-label">
      Wachtwoord
      <input type="password" id="secret" class="gen-input" autocomplete="off" />
    </label>

    <label class="gen-label">
      Aantal woorden
      <select id="count" class="gen-input">
        {Array.from({ length: 30 }, (_, i) => (
          <option value={i + 1}>{i + 1}</option>
        ))}
      </select>
    </label>

    <button id="generate-btn" class="gen-btn">Genereer</button>
  </div>

  <div id="status" class="gen-status" style="display:none;"></div>

  <div id="results" class="gen-results" style="display:none;">
    <h2 class="gen-results-heading">Gegenereerde woorden</h2>
    <div id="results-list"></div>

    <div id="save-section" style="display:none;">
      <button id="save-btn" class="gen-btn gen-btn-save">Opslaan naar GitHub</button>
    </div>
  </div>

  <div id="save-status" class="gen-status" style="display:none;"></div>

  <script define:vars={{ existingWordNames, lastDate }}>
    const secretInput = document.getElementById('secret');
    const countSelect = document.getElementById('count');
    const generateBtn = document.getElementById('generate-btn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const resultsListEl = document.getElementById('results-list');
    const saveSectionEl = document.getElementById('save-section');
    const saveBtn = document.getElementById('save-btn');
    const saveStatusEl = document.getElementById('save-status');

    let generatedWords = [];
    let allExistingWords = [...existingWordNames];

    function addDays(dateStr, n) {
      const [y, m, d] = dateStr.split('-').map(Number);
      const date = new Date(y, m - 1, d + n);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function showStatus(el, message, type = 'info') {
      el.textContent = message;
      el.className = `gen-status gen-status-${type}`;
      el.style.display = 'block';
    }

    function hideStatus(el) {
      el.style.display = 'none';
    }

    function el(tag, className, text) {
      const node = document.createElement(tag);
      if (className) node.className = className;
      if (text) node.textContent = text;
      return node;
    }

    function renderResults() {
      resultsListEl.innerHTML = '';
      generatedWords.forEach((item, i) => {
        const card = el('div', 'gen-result-card');

        const valid = item.verification?.valid;

        const label = el('label', 'gen-result-header');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'gen-checkbox';
        checkbox.dataset.index = i;
        if (valid) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(el('span', 'gen-result-word', item.word));
        label.appendChild(el('span', 'gen-result-date', item.date));
        label.appendChild(el('span', `gen-result-status ${valid ? 'gen-valid' : 'gen-invalid'}`, valid ? 'Geldig' : 'Ongeldig'));
        card.appendChild(label);

        card.appendChild(el('p', 'gen-result-explanation', item.explanation));
        card.appendChild(el('p', 'gen-result-example', item.example));

        if (item.verification?.reason) {
          card.appendChild(el('p', 'gen-result-reason', item.verification.reason));
        }

        resultsListEl.appendChild(card);
      });

      resultsEl.style.display = generatedWords.length > 0 ? 'block' : 'none';
      saveSectionEl.style.display = generatedWords.length > 0 ? 'block' : 'none';
    }

    generateBtn.addEventListener('click', async () => {
      const secret = secretInput.value.trim();
      if (!secret) {
        showStatus(statusEl, 'Voer een wachtwoord in.', 'error');
        return;
      }

      const count = parseInt(countSelect.value, 10);
      generatedWords = [];
      renderResults();
      hideStatus(saveStatusEl);

      generateBtn.disabled = true;
      showStatus(statusEl, `${count} woord${count !== 1 ? 'en' : ''} genereren...`);

      try {
        const res = await fetch('/api/generate-word', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ secret, existingWords: allExistingWords, aantal: count }),
        });

        const data = await res.json();

        if (!res.ok) {
          showStatus(statusEl, data.error || 'Fout bij genereren.', 'error');
          generateBtn.disabled = false;
          return;
        }

        let nextDate = lastDate;
        for (const item of data.words) {
          nextDate = addDays(nextDate, 1);
          generatedWords.push({
            date: nextDate,
            word: item.word,
            explanation: item.explanation,
            example: item.example,
            verification: item.verification,
          });
          allExistingWords.push(item.word);
        }

        renderResults();
        showStatus(statusEl, `${generatedWords.length} woord${generatedWords.length !== 1 ? 'en' : ''} gegenereerd.`, 'success');
      } catch (err) {
        showStatus(statusEl, `Fout: ${err.message}`, 'error');
      }

      generateBtn.disabled = false;
    });

    saveBtn.addEventListener('click', async () => {
      const secret = secretInput.value.trim();
      if (!secret) {
        showStatus(saveStatusEl, 'Voer een wachtwoord in.', 'error');
        return;
      }

      // Get checked words
      const checkboxes = resultsListEl.querySelectorAll('.gen-checkbox');
      const approvedWords = [];
      checkboxes.forEach((cb) => {
        if (cb.checked) {
          const idx = parseInt(cb.dataset.index, 10);
          const w = generatedWords[idx];
          approvedWords.push({
            date: w.date,
            word: w.word,
            explanation: w.explanation,
            example: w.example,
          });
        }
      });

      if (approvedWords.length === 0) {
        showStatus(saveStatusEl, 'Selecteer minstens een woord om op te slaan.', 'error');
        return;
      }

      saveBtn.disabled = true;
      showStatus(saveStatusEl, `${approvedWords.length} woord${approvedWords.length !== 1 ? 'en' : ''} opslaan...`);

      try {
        const res = await fetch('/api/commit-words', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ secret, words: approvedWords }),
        });

        const data = await res.json();

        if (!res.ok) {
          showStatus(saveStatusEl, data.error || 'Fout bij opslaan.', 'error');
          saveBtn.disabled = false;
          return;
        }

        showStatus(saveStatusEl, `${data.message} De site wordt automatisch opnieuw gebouwd.`, 'success');
        saveBtn.disabled = false;
      } catch (err) {
        showStatus(saveStatusEl, `Fout: ${err.message}`, 'error');
        saveBtn.disabled = false;
      }
    });
  </script>
</Layout>
